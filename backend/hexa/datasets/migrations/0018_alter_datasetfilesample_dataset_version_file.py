# Generated by Django 5.2.9 on 2026-02-17 15:44

import django.db.models.deletion
from django.db import migrations, models
from django.db.models import OuterRef, Subquery


def deduplicate_samples(apps, schema_editor):
    DatasetFileSample = apps.get_model("datasets", "DatasetFileSample")

    latest_ids = (
        DatasetFileSample.objects.filter(
            dataset_version_file=OuterRef("dataset_version_file")
        )
        .order_by("-created_at")
        .values("id")[:1]
    )

    # Delete all non-latest samples
    DatasetFileSample.objects.exclude(id__in=Subquery(latest_ids)).delete()


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("datasets", "0017_datasetversionfile_rows"),
    ]

    operations = [
        migrations.RunPython(deduplicate_samples, migrations.RunPython.noop),
        migrations.AlterField(
            model_name="datasetfilesample",
            name="dataset_version_file",
            field=models.OneToOneField(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="sample_entry",
                to="datasets.datasetversionfile",
            ),
        ),
    ]
