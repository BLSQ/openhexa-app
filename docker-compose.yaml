version: "3.9"

# Defines a service that can be reused multiple times later
x-app: &common
    build:
      context: .
      dockerfile: Dockerfile
      target: app
    networks:
      - openhexa
    environment:
      - DEBUG=true
      - SESSION_COOKIE_SECURE=false
      - CSRF_COOKIE_SECURE=false
      - SECURE_SSL_REDIRECT=false
      - ALLOWED_HOSTS=*
      - DATABASE_HOST=db
      - DATABASE_PORT=5432
      - DATABASE_NAME=hexa-app
      - DATABASE_USER=hexa-app
      - DATABASE_PASSWORD=hexa-app
      - SECRET_KEY='))dodw9%n)7q86l-q1by4e-2z#vonph50!%ep7_je)_=x0m2v-'
      - ENCRYPTION_KEY='oT7DKt8zf0vsnbBcJ0R36SHkBzbjF2agFIK3hSAVvko='
      - CORS_ALLOWED_ORIGINS=http://localhost:3000
      - CSRF_TRUSTED_ORIGINS=http://localhost:3000
      - GCS_TOKEN_LIFETIME=3600
      - ACCESSMOD_BUCKET_NAME=s3://hexa-demo-accessmod
      - ACCESSMOD_MANAGE_REQUESTS_URL=http://localhost:3000/admin/access-requests
      - ACCESSMOD_SET_PASSWORD_URL=http://localhost:3000/account/set-password
      - NEW_FRONTEND_DOMAIN=localhost:3000
      - PIPELINE_SCHEDULER_SPAWNER=docker
      - PIPELINE_API_URL=http://app:8000
      - PIPELINE_IMAGE

      # The following variables are optional and can be set in your local .env file for testing purposes
      - DEBUG_LOGGING
      - DEBUG_TOOLBAR
      - EMAIL_HOST
      - EMAIL_PORT
      - EMAIL_HOST_USER
      - EMAIL_USE_TLS
      - EMAIL_HOST_PASSWORD
      - WORKSPACES_DATABASE_ROLE=hexa-app
      - WORKSPACES_DATABASE_PASSWORD=hexa-app
      - WORKSPACES_DATABASE_HOST=db
      - WORKSPACES_DATABASE_PORT=5432
      - WORKSPACES_DATABASE_DEFAULT_DB=hexa-app
      - WORKSPACES_DATABASE_PROXY_HOST=db
      - NOTEBOOKS_API_URL=http://host.docker.internal:8001/hub/api
      - HUB_API_TOKEN=cbb352d6a412e266d7494fb014dd699373645ec8d353e00c7aa9dc79ca87800d
      - GCS_SERVICE_ACCOUNT_KEY
      - WORKSPACE_BUCKET_PREFIX=hexa-test-
      - WORKSPACE_BUCKET_REGION=europe-west1
      - AWS_USERNAME
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_ENDPOINT_URL
      - AWS_DEFAULT_REGION
      - AWS_USER_ARN
      - AWS_APP_ROLE_ARN
      - AWS_PERMISSIONS_BOUNDARY_POLICY_ARN
    volumes:  # only used for Github Codespaces
      - "${LOCAL_WORKSPACE_FOLDER:-.}:/code"
    

services:
  db:
    image: postgis/postgis:12-3.2
    networks:
      - openhexa
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=hexa-app
      - POSTGRES_USER=hexa-app
      - POSTGRES_PASSWORD=hexa-app
    ports:
      - "5432:5432"

  app:
    # Inherit from the block defined on top and override some fields
    <<: *common
    command: "manage runserver 0:8000"
    restart: unless-stopped
    ports:
      - "8000:8000"
    depends_on:
      - db

  dataworker:
    <<: *common
    command: "manage validate_fileset_worker"
    restart: unless-stopped
    profiles:
      - "dataworker"
    depends_on:
      - db

  pipelines_runner:
    <<: *common
    
    build:
      context: .
      dockerfile: Dockerfile
      target: pipelines
    command: "manage pipelines_runner"
    restart: unless-stopped
    profiles:
      - "pipelines"
    depends_on:
      - db
    volumes:  # only used for Github Codespaces
      - "${LOCAL_WORKSPACE_FOLDER:-.}:/code"
      - /var/run/docker.sock:/var/run/docker.sock

  pipelines_scheduler:
    <<: *common
    build:
      context: .
      dockerfile: Dockerfile
      target: pipelines
    command: "manage pipelines_scheduler"
    restart: unless-stopped
    profiles:
      - "pipelines"
    depends_on:
      - db

networks:
  openhexa:
    name: openhexa
    external: true
volumes:
  pgdata:
